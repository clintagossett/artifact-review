# Novu Notifications Setup

This guide covers setting up and testing Novu notifications for comment notifications in Artifact Review.

## Overview

The notification system uses:
- **Shared Novu Instance** - Self-hosted notification orchestration (https://novu.loc)
- **Novu Bridge** - Next.js API route for workflow discovery/execution
- **Novu Notification Center** - React component for in-app notifications

## Architecture

```
User comments → Convex trigger → Novu (local) → Bridge → Workflow → In-App (real-time)
                                                                  ↓
                                                            Digest (batching)
                                                                  ↓
                                              Email Webhook → Convex HTTP → Resend → Mailpit
```

**Email Flow:** Instead of Novu sending emails directly via Resend, Novu POSTs to our Convex webhook. Convex renders React Email templates and sends via Resend (which goes to Mailpit in local dev).

## Prerequisites

The shared Novu instance must be running. See the infrastructure setup guide:
**`/home/clint-gossett/Documents/agentic-dev/docs/guides/shared-novu.md`**

## Environment Variables

**IMPORTANT:** Novu credentials are **per-agent** - each agent gets unique credentials from `setup-novu-org.sh`. Do NOT copy Novu credentials from shared secrets or other agents.

### Frontend Variables (`.env.local` or `.env.nextjs.local`)

```bash
# Novu API endpoint (shared local instance)
NOVU_API_URL=https://api.novu.loc
NEXT_PUBLIC_NOVU_API_URL=https://api.novu.loc
NEXT_PUBLIC_NOVU_SOCKET_URL=wss://ws.novu.loc

# Novu Secret Key (auto-populated by setup-novu-org.sh)
NOVU_SECRET_KEY=your-agent-secret-key

# Novu Application ID (auto-populated by setup-novu-org.sh)
NEXT_PUBLIC_NOVU_APPLICATION_IDENTIFIER=your-agent-app-id
```

### Backend Variables (`.env.convex.local`)

The Convex backend also needs Novu credentials to trigger notifications:

```bash
# Novu Configuration (auto-generated by setup-novu-org.sh)
NOVU_SECRET_KEY=your-agent-secret-key
NOVU_API_URL=https://api.novu.loc
```

After updating `.env.convex.local`, sync to Convex:
```bash
./scripts/setup-convex-env.sh --sync
```

### Digest Interval (Next.js / Vercel — NOT Convex)

> **IMPORTANT:** `NOVU_DIGEST_INTERVAL` is read by the Novu bridge, which runs inside the **Next.js process** (`/api/novu`). It must be set as a **Next.js environment variable** (in `.env.nextjs.local` for local dev, or as a **Vercel env var** for hosted environments). Setting it in Convex (`.env.convex.local`) has **no effect** on digest timing.

```bash
# In app/.env.nextjs.local (local dev) or Vercel dashboard (hosted)
# Format: <number><unit> where unit is s (seconds), m (minutes), or h (hours)
#
# Recommended values:
#   30s  - local dev (fast testing)
#   2m   - staging (verify batching works)
#   20m  - production (real user experience)
#
# Default (if unset): 10m
NOVU_DIGEST_INTERVAL=30s
```

**After changing on hosted environments:** You must redeploy the Vercel project AND re-sync the Novu workflow. See [docs/ENVIRONMENT_VARIABLES.md](../ENVIRONMENT_VARIABLES.md#-novu_digest_interval) for the sync command.

## Local Development Setup

### Email Address Configuration

**IMPORTANT:** Novu sends notification emails using the `notify@` email address, NOT the `auth@` address.

| Email Type | Sent Via | Email Address | Configuration |
|------------|----------|---------------|---------------|
| Authentication (magic links, password resets) | Direct Resend (Convex) | `auth@artifactreview-early.xyz` (staging)<br/>`auth@artifactreview.com` (prod) | Convex env var: `EMAIL_FROM_AUTH` |
| Notifications (invitations, comments, mentions) | Novu → Resend | `notify@artifactreview-early.xyz` (staging)<br/>`notify@artifactreview.com` (prod) | Novu Dashboard: Integrations → Resend |

When configuring Novu's Resend integration (see steps below), use:
- **From Name**: `Artifact Review`
- **From Email**: `notify@artifactreview-early.xyz` (staging) or `notify@artifactreview.com` (production)

### 1. Create Novu Organization (First Time Only)

**IMPORTANT:** On first-time setup, the local Novu database is empty. You must create an account and organization (data persists after setup).

**Option A: Automated Setup (Recommended)**

```bash
./scripts/setup-novu-org.sh
```

This script will:
- Check if Novu is available (fails gracefully with instructions if not)
- Create user and organization with standard credentials
- Retrieve API keys
- Update `app/.env.local` automatically
- Configure email webhook integration (Novu → Convex → Resend)

To check if already configured (including email webhook):
```bash
./scripts/setup-novu-org.sh --check
```

To add email webhook to an existing setup (existing agents):
```bash
./scripts/setup-novu-org.sh --fix-email
```

**Option B: Manual Setup**

Standard credentials (use these exact values):

| Field | Value |
|-------|-------|
| Email | `admin@mark.loc` |
| Password | `Password123$` |
| Organization | `mark-artifact-review` |

1. Ensure orchestrator is running: `cd /home/clint-gossett/Documents/agentic-dev/orchestrator && ./start.sh`
2. Go to https://novu.loc
3. Click **Sign Up** with the standard credentials above
4. Create organization `mark-artifact-review` when prompted
5. Go to **Settings → API Keys**
6. Copy the **Secret Key** and **Application Identifier**

### 2. Configure Environment

If you used the automated setup, `.env.local` is already configured.

For manual setup, add the credentials to your `.env.local`:

```bash
cd app
# Edit .env.local with your Novu credentials from Step 1
```

Example:
```bash
NOVU_API_URL=https://api.novu.loc
NOVU_SECRET_KEY=abc123...
NEXT_PUBLIC_NOVU_APPLICATION_IDENTIFIER=def456...
```

### 3. Start Development Servers

```bash
./scripts/start-dev-servers.sh
```

### 4. Configure Email Webhook Integration

**NOTE:** This step is now handled automatically by `setup-novu-org.sh` (step 1). If you ran `setup-novu-org.sh` after this was added, the email webhook is already configured.

**For existing agents missing the email webhook:**
```bash
./scripts/setup-novu-org.sh --fix-email
# Or directly:
./scripts/setup-novu-email-webhook.sh
```

This configures Novu to POST email payloads to `https://{AGENT_NAME}.convex.site.loc/novu-email-webhook`.

**Check status:**
```bash
./scripts/setup-novu-org.sh --check
# Or directly:
./scripts/setup-novu-email-webhook.sh --check
```

**Prerequisites:**
- `NOVU_EMAIL_WEBHOOK_SECRET` must be set in `app/.env.convex.local`
- Generate with: `openssl rand -hex 32`
- Sync to Convex: `./scripts/setup-convex-env.sh --sync`

**If emails aren't arriving:**
1. Verify webhook exists: `./scripts/setup-novu-org.sh --check`
2. Delete and recreate: `./scripts/setup-novu-email-webhook.sh --delete && ./scripts/setup-novu-email-webhook.sh`

### 5. Workflow Sync (Automatic)

**Workflows sync automatically** when you run `./scripts/start-dev-servers.sh`. The script:
1. Waits for Next.js to be ready (bridge endpoint available)
2. Calls the Novu sync API to register workflows
3. Reports success/failure in the startup output

You should see output like:
```
Syncing Novu workflows...
  Waiting for bridge endpoint...
  ✅ Bridge endpoint ready
  Syncing to Novu...
  ✅ Novu workflows synced (1 workflows)
```

#### Manual Sync (If Needed)

If automatic sync fails, you can sync manually:

**Option A: CLI**
```bash
npx novu@latest sync \
  --bridge-url https://mark.loc/api/novu \
  --secret-key $(grep NOVU_SECRET_KEY app/.env.nextjs.local | cut -d= -f2) \
  --api-url https://api.novu.loc
```

**Option B: API (curl)**
```bash
curl -X POST https://api.novu.loc/v1/bridge/sync \
  -H "Authorization: ApiKey $(grep NOVU_SECRET_KEY app/.env.nextjs.local | cut -d= -f2)" \
  -H "Content-Type: application/json" \
  -d '{"bridgeUrl": "https://mark.loc/api/novu"}'
```

**Option C: Web UI**
1. Go to https://novu.loc → **Integrations** → **Local Studio**
2. Enter bridge URL: `https://mark.loc/api/novu`
3. Click **Sync**

#### Verify Sync

```bash
curl -s https://api.novu.loc/v1/workflows \
  -H "Authorization: ApiKey $(grep NOVU_SECRET_KEY app/.env.nextjs.local | cut -d= -f2)" \
  | jq '.data[].name'
```

Expected output: `"new-comment"`

## Workflow Details

### Workflow: `new-comment`

Located at: `app/src/app/api/novu/workflows/comment-workflow.ts`

#### Payload Schema

```typescript
{
  artifactDisplayTitle: string;  // Required: e.g., "My Design Doc"
  authorName: string;            // Required: e.g., "John Doe"
  commentPreview: string;        // Required: e.g., "This looks great!"
  artifactUrl: string;           // Required: e.g., "https://..."
  authorAvatarUrl?: string;      // Optional: avatar image URL
  isReply?: boolean;             // Optional: true if replying to a comment
  isCommentAuthor?: boolean;     // Optional: true if recipient is comment author
}
```

#### Steps

1. **In-App Notification** - Real-time bell icon notification
2. **Digest** - Batches notifications for 10 minutes (configurable)
3. **Email** - Sends digested email with all notifications

### Notification Content

#### In-App Subject Lines

| Scenario | Subject |
|----------|---------|
| New comment | "New comment on {artifactTitle}" |
| Reply to author | "{authorName} replied to your comment" |
| Reply to participant | "New reply on {artifactTitle}" |

#### Email Subject Lines

| Scenario | Subject |
|----------|---------|
| Single comment | "New comment from {author} on {artifact}" |
| Single reply | "{author} replied on {artifact}" |
| Multiple comments | "3 comments on {artifact}" |
| Mixed | "2 comments and 1 reply on {artifact}" |

## Testing

### Run Unit Tests

```bash
cd app
npm run test -- ../tasks/00043-novu-comment-notifications/02-novu-workflow-setup/tests/unit/
```

### Test Manually

1. Create a comment on an artifact
2. Wait for digest interval (default 10m, set `NOVU_DIGEST_INTERVAL=30s` for faster local testing)
3. Check the bell icon for in-app notification
4. Check email inbox for digest email

### Test Selectors (E2E)

The NotificationCenter component includes test selectors:

- `data-testid="notification-bell"` - Bell icon container
- `data-testid="notification-badge"` - Unseen count badge
- `data-testid="notification-count"` - Count number

## Troubleshooting

### Workflow Not Found in Novu

**Symptom:** Notifications fail with "workflow not found" error.

**Cause:** Workflow sync failed or hasn't run yet.

**Fix:**
1. Check startup output for sync errors
2. Restart dev servers: `./scripts/start-dev-servers.sh --restart`
3. If still failing, manual sync (see "4. Workflow Sync" above)

### Bridge Not Syncing

1. Ensure `NOVU_SECRET_KEY` in `.env.nextjs.local` matches your Novu org
2. Check that the Next.js dev server is running (`tmux attach -t mark-nextjs`)
3. Verify the bridge URL uses your agent domain: `https://mark.loc/api/novu` (NOT localhost)
4. Test the bridge endpoint directly:
   ```bash
   curl -s https://mark.loc/api/novu | jq .
   ```

### Wrong Novu Credentials

**Symptom:** API returns 401 or notifications go to wrong organization.

**Cause:** Novu credentials are per-agent. Using another agent's credentials breaks notifications.

**Fix:**
1. Run `./scripts/setup-novu-org.sh` to get your agent's credentials
2. Verify credentials match in both files:
   - `app/.env.nextjs.local` (frontend)
   - `app/.env.convex.local` (backend)
3. Sync to Convex: `./scripts/setup-convex-env.sh --sync`

### Notifications Not Appearing

1. Verify subscriber is created (check `users` table for `novuSubscriberId`)
2. Check Novu dashboard → Activity for logs
3. Ensure `NEXT_PUBLIC_NOVU_APPLICATION_IDENTIFIER` is correct
4. Check browser console for Novu errors
5. Verify workflow is synced: check https://novu.loc → Workflows

### Email Not Sending

1. Wait for digest interval to complete (default 30s local, 10m prod)
2. Verify Email Webhook integration: `./scripts/setup-novu-email-webhook.sh --check`
3. Check Convex logs for webhook errors:
   ```bash
   source .env.docker.local
   tmux capture-pane -t ${AGENT_NAME}-convex-dev -p | grep -i "novu"
   ```
4. Check Novu dashboard → Activity → Email logs for delivery status
5. Verify email appears in Mailpit: `https://{AGENT_NAME}.mailpit.loc`

### Bridge Endpoint Broken (BridgeMethodNotConfigured)

**Symptom:** Novu returns `"BridgeMethodNotConfigured"` error.

**Cause:** Usually `"use node"` directive in React Email templates being imported into Next.js.

**Fix:**
1. Ensure `convex/emails/*.tsx` templates do NOT have `"use node"` at the top
2. Only `convex/lib/emailRenderer.ts` should have `"use node"`
3. Restart dev servers: `./scripts/start-dev-servers.sh --restart`

**Test bridge:**
```bash
curl -s https://{AGENT_NAME}.loc/api/novu | jq .
# Should return: {"status":"ok","sdkVersion":"...","discovered":{"workflows":1,"steps":3}}
```

### Wrong Content in Notifications

1. Check payload schema matches expected format
2. Verify `isReply` and `isCommentAuthor` flags are set correctly
3. Run unit tests to verify content generation logic

## Files Reference

| File | Purpose |
|------|---------|
| `app/src/app/api/novu/route.ts` | Bridge endpoint (GET, POST, OPTIONS) |
| `app/src/app/api/novu/workflows/comment-workflow.ts` | Workflow definition |
| `app/src/lib/emailRenderer.ts` | Next.js email renderer (for bridge) |
| `app/src/components/NotificationCenter.tsx` | React notification bell |
| `app/convex/novu.ts` | Backend trigger functions |
| `app/convex/novuEmailWebhook.ts` | Email webhook handler |
| `app/convex/http.ts` | HTTP routes (includes `/novu-email-webhook`) |
| `app/convex/emails/*.tsx` | React Email templates |
| `app/convex/lib/emailRenderer.ts` | Convex email renderer |
| `scripts/setup-novu-email-webhook.sh` | Email Webhook integration setup |
| `app/.env.convex.local.example` | Backend env vars (includes NOVU_EMAIL_WEBHOOK_SECRET) |
| `app/.env.nextjs.local.example` | Frontend env vars |

## Related Documentation

- [Shared Novu Setup](/home/clint-gossett/Documents/agentic-dev/docs/guides/shared-novu.md) - Infrastructure setup
- [Environment Template](/home/clint-gossett/Documents/agentic-dev/docs/agents/env-template.md) - All env vars
- [Novu Framework Docs](https://docs.novu.co/framework/introduction)
- [Novu Notification Center](https://docs.novu.co/notification-center/introduction)
- [Convex Backend Rules](../architecture/convex-rules.md)
