# Architectural Analysis: Agent Init Overhaul

## Executive Summary

The agent initialization process currently suffers from **fragmented configuration sources** and **missing orchestration logic**. This analysis identifies 8 critical issues and proposes a unified solution centered on making `agent-init.sh` the single source of truth for all agent environment setup.

---

## Current State Analysis

### Configuration Sources (Problem: Multiple Sources of Truth)

| File | Purpose | Generated By | Status |
|------|---------|--------------|--------|
| `.env.docker.local` | Agent identity, ports, Docker vars | `agent-init.sh` from `config.json` | ✅ Working |
| `app/.env.local` | Next.js runtime (Convex URLs) | `start-dev-servers.sh` (dynamic) | ⚠️ Partial |
| `app/.env.nextjs.local` | Secrets, Novu, Resend | Manual copy from example | ❌ Broken |
| `app/.env.convex.local` | Convex backend env vars | Manual copy from example | ⚠️ Unused |

**Key Insight:** The orchestrator `config.json` has correct port assignments, but they don't flow to all env files.

### Script Execution Order (Current)

```
agent-init.sh
├── 1. setup_env_files() - Only generates .env.docker.local
├── 2. verify_orchestrator()
├── 3. install_dependencies() - Runs npm install
├── 4. start_convex_container() - Docker up
├── 5. setup_novu() - ./setup-novu-org.sh
└── 6. configure_convex_env() - ./setup-convex-env.sh
```

**Missing Steps:**
- Generate `app/.env.nextjs.local` from config
- Set NODE_EXTRA_CA_CERTS
- Set RESEND_API_KEY in Convex
- Restart Convex dev server to pick up env changes
- Health checks between steps

---

## Critical Issues Identified

### Issue 1: npm install Not Before Docker

**Location:** `agent-init.sh` lines 327-343

**Current:** npm install runs in step 3, Docker starts in step 4.

**Problem:** This is actually correct order, but npm install doesn't use `--legacy-peer-deps` consistently.

**Current Code:**
```bash
npm install --legacy-peer-deps
```

**Status:** ✅ Already correct, but verify flag is always used.

---

### Issue 2: Port Mismatches in .env Files

**Location:** `app/.env.nextjs.local.example` line 12

**Current:**
```bash
CONVEX_SELF_HOSTED_URL=http://127.0.0.1:3220
```

**Problem:** Hardcoded port 3220 doesn't match orchestrator config. For `mark` agent, the correct port is 3240 (`appPort` + 210).

**Correct for james (appPort=3020):**
```bash
CONVEX_SELF_HOSTED_URL=http://127.0.0.1:3230
```

**Solution:** Generate this file from config.json using the formula:
```
convexCloudPort = appPort + 210
convexSitePort = appPort + 211
```

Wait - checking config.json again... The config already has explicit ports:
```json
"james": {
  "appPort": 3020,
  "convexCloudPort": 3230,  // This IS the admin port
  "convexSitePort": 3231,   // This is HTTP port
  ...
}
```

So the script should read `convexCloudPort` directly, not calculate it.

---

### Issue 3: Placeholder Values Not Replaced

**Location:** `app/.env.nextjs.local.example` line 74

**Current:**
```bash
NODE_EXTRA_CA_CERTS=/home/YOUR_USERNAME/.local/share/mkcert/rootCA.pem
```

**Problem:** `YOUR_USERNAME` is never replaced with actual value.

**Solution:** Use `mkcert -CAROOT` to get the correct path dynamically:
```bash
NODE_EXTRA_CA_CERTS="$(mkcert -CAROOT)/rootCA.pem"
```

---

### Issue 4: NODE_EXTRA_CA_CERTS Not Set

**Location:** Multiple files need this

The variable is needed in:
1. `app/.env.nextjs.local` - For Next.js/Playwright
2. Shell environment for `npx convex dev`
3. Inside Docker containers (already handled via docker-compose.yml)

**Current Handling in `start-dev-servers.sh` (lines 284-290):**
```bash
if [ -z "$NODE_EXTRA_CA_CERTS" ]; then
    MKCERT_CA="$(mkcert -CAROOT 2>/dev/null)/rootCA.pem"
    if [ -f "$MKCERT_CA" ]; then
        export NODE_EXTRA_CA_CERTS="$MKCERT_CA"
    fi
fi
```

**Problem:** This only exports for the current shell, doesn't persist to env files.

**Solution:** Write to `.env.nextjs.local` during generation.

---

### Issue 5: Scripts Use Proxy URLs for CLI Operations

**Location:** `setup-convex-env.sh` line 236

**Current:**
```bash
npx convex env set --env-file "$env_file" -- CONVEX_SELF_HOSTED_URL "https://${AGENT_NAME}.convex.cloud.loc"
```

**Problem:** This uses the proxy URL. For CLI operations, we should use localhost:
```bash
CONVEX_SELF_HOSTED_URL=http://127.0.0.1:${convexCloudPort}
```

**Analysis:** Actually, looking at the code flow:
- The `.env.local` file uses `http://127.0.0.1:port` for CLI
- The Convex backend env var uses the proxy URL (correct for browser access)

This is actually correct! The confusion is about which URL goes where:
- **CLI (npx convex)** reads from `CONVEX_SELF_HOSTED_URL` in `.env.local` → localhost
- **Browser** reads from `NEXT_PUBLIC_CONVEX_URL` → proxy URL
- **Convex env vars** (SITE_URL, CONVEX_SELF_HOSTED_URL) → proxy URLs for browser

**Verdict:** Current approach is correct, but documentation is confusing.

---

### Issue 6: Novu "User Already Exists" Not Handled Gracefully

**Location:** `setup-novu-org.sh` lines 98-114

**Current Code (already handles this!):**
```bash
try_login() {
    log_info "Checking if user already exists..."
    LOGIN_RESPONSE=$(curl -s "$NOVU_API_URL/v1/auth/login" ...)
    TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.data.token // empty')
    if [ -n "$TOKEN" ]; then
        log_info "User exists, logged in successfully"
        return 0
    fi
    return 1
}
```

**Verdict:** ✅ Already idempotent - tries login first, registers only if login fails.

---

### Issue 7: RESEND_API_KEY Not Set

**Location:** Convex environment

**Problem:** The Convex backend needs `RESEND_API_KEY` set, but it's not done automatically.

**Current State:**
- `app/.env.convex.local.example` has `RESEND_API_KEY=re_dummy_key_for_localhost`
- But this file isn't synced to Convex env vars

**Solution:** Add to `agent-init.sh` after Novu setup:
```bash
npx convex env set -- RESEND_API_KEY "re_dummy_key_for_localhost"
```

---

### Issue 8: Convex Env Vars Need Server Restart

**Location:** `agent-init.sh` - missing step

**Problem:** After setting Convex environment variables, the dev server needs to restart to pick them up.

**Solution:** Add restart step at end of init:
```bash
# Restart Convex dev to pick up new env vars
if tmux has-session -t "${AGENT_NAME}-convex-dev" 2>/dev/null; then
    tmux kill-session -t "${AGENT_NAME}-convex-dev"
fi
./scripts/start-dev-servers.sh
```

---

## Proposed Solution Architecture

### New Execution Flow

```
agent-init.sh (single entry point)
│
├── Phase 1: Prerequisites
│   ├── check_prerequisites()      # Node, Docker, tmux, jq, mkcert
│   └── detect_agent_name()        # From directory name
│
├── Phase 2: Configuration Generation
│   ├── generate_env_docker_local()    # From config.json (existing)
│   ├── generate_env_nextjs_local()    # NEW: From config.json
│   ├── generate_env_local()           # NEW: Dynamic Convex URLs
│   └── set_node_ca_certs()            # NEW: Auto-detect mkcert CA
│
├── Phase 3: Dependencies
│   └── install_dependencies()     # npm install --legacy-peer-deps
│
├── Phase 4: Infrastructure
│   ├── verify_orchestrator()      # Check/start orchestrator
│   ├── start_docker_services()    # docker compose up -d
│   └── wait_for_backend()         # Health check loop
│
├── Phase 5: Service Configuration
│   ├── setup_novu()               # Idempotent Novu org setup
│   ├── configure_convex_env()     # JWT keys, RESEND_API_KEY, etc.
│   └── set_resend_key()           # NEW: Set dummy RESEND_API_KEY
│
├── Phase 6: Dev Servers
│   ├── start_dev_servers()        # tmux sessions
│   └── wait_for_ready()           # Health check all endpoints
│
└── Phase 7: Validation
    └── show_status()              # URLs, credentials, next steps
```

### New File: `scripts/generate-all-env.sh`

This script generates ALL env files from the single source of truth (`config.json`):

```bash
#!/bin/bash
# Generate all environment files from orchestrator config.json

generate_env_nextjs_local() {
    local agent_name="$1"
    local config_file="$2"

    # Read ports from config.json
    local app_port=$(jq -r ".\"$agent_name\".appPort // .default.appPort" "$config_file")
    local convex_cloud_port=$(jq -r ".\"$agent_name\".convexCloudPort // .default.convexCloudPort" "$config_file")
    local convex_site_port=$(jq -r ".\"$agent_name\".convexSitePort // .default.convexSitePort" "$config_file")
    local mailpit_port=$(jq -r ".\"$agent_name\".mailpitPort // .default.mailpitPort" "$config_file")

    # Get mkcert CA path
    local mkcert_ca="$(mkcert -CAROOT 2>/dev/null)/rootCA.pem"

    cat > app/.env.nextjs.local << EOF
# AUTO-GENERATED by ./scripts/agent-init.sh
# Generated: $(date -Iseconds)
# Source: ../artifact-review-orchestrator/config.json

# Convex Connection (CLI uses localhost, browser uses proxy)
CONVEX_SELF_HOSTED_URL=http://127.0.0.1:${convex_cloud_port}
NEXT_PUBLIC_CONVEX_URL=https://${agent_name}.convex.cloud.loc
NEXT_PUBLIC_CONVEX_HTTP_URL=https://${agent_name}.convex.site.loc

# Site URLs
SITE_URL=https://${agent_name}.loc
CONVEX_SITE_URL=https://${agent_name}.convex.site.loc

# Email (local dev uses Mailpit)
RESEND_FULL_ACCESS_API_KEY=re_dummy_key_for_localhost
EMAIL_FROM_AUTH="Artifact Review <auth@artifactreview-early.xyz>"
EMAIL_FROM_NOTIFICATIONS="Artifact Review <notify@artifactreview-early.xyz>"

# Novu (populated by setup-novu-org.sh)
NOVU_SECRET_KEY=
NEXT_PUBLIC_NOVU_APPLICATION_IDENTIFIER=
NOVU_API_URL=https://api.novu.loc
NEXT_PUBLIC_NOVU_API_URL=https://api.novu.loc
NEXT_PUBLIC_NOVU_SOCKET_URL=wss://ws.novu.loc

# Local Dev Tools
MAILPIT_API_URL=https://${agent_name}.mailpit.loc/api/v1

# TLS Certificates (mkcert)
NODE_EXTRA_CA_CERTS=${mkcert_ca}
EOF
}
```

### New File: `scripts/wait-for-services.sh`

```bash
#!/bin/bash
# Wait for all services to be healthy

wait_for_url() {
    local url="$1"
    local name="$2"
    local max_attempts="${3:-30}"
    local attempt=1

    while [ $attempt -le $max_attempts ]; do
        if curl -s -o /dev/null -w "%{http_code}" "$url" 2>/dev/null | grep -qE "^(200|302|401|404)$"; then
            echo "✅ $name is ready"
            return 0
        fi
        echo "⏳ Waiting for $name... ($attempt/$max_attempts)"
        sleep 2
        attempt=$((attempt + 1))
    done

    echo "❌ $name failed to start"
    return 1
}

# Main
source .env.docker.local

wait_for_url "http://127.0.0.1:${CONVEX_ADMIN_PORT:-3230}/version" "Convex Backend" || exit 1
wait_for_url "https://${AGENT_NAME}.loc" "Next.js" || exit 1
wait_for_url "https://api.novu.loc/v1/health-check" "Novu API" || exit 1
```

---

## Schema Design: Environment Variable Flow

### Single Source of Truth

```
┌─────────────────────────────────────────────────────────────┐
│              config.json (Orchestrator)                     │
│                                                             │
│  "james": {                                                 │
│    "appPort": 3020,                                         │
│    "convexCloudPort": 3230,                                 │
│    "convexSitePort": 3231,                                  │
│    "mailpitPort": 8045,                                     │
│    "convexDashboardPort": 6811,                             │
│    "subnet": "172.28"                                       │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│              agent-init.sh (Generator)                      │
│                                                             │
│  Reads config.json                                          │
│  Generates ALL env files                                    │
│  Sets Convex env vars                                       │
└─────────────────────────────────────────────────────────────┘
                           │
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│ .env.docker.local│ │.env.nextjs.local │ │  .env.local      │
│                  │ │                  │ │                  │
│ AGENT_NAME       │ │ CONVEX_SELF_     │ │ NEXT_PUBLIC_     │
│ BASE_PORT        │ │   HOSTED_URL     │ │   CONVEX_URL     │
│ SUBNET           │ │ NODE_EXTRA_CA_   │ │ CONVEX_SELF_     │
│ (Docker compose) │ │   CERTS          │ │   HOSTED_URL     │
│                  │ │ (Secrets/Config) │ │ (Runtime URLs)   │
└──────────────────┘ └──────────────────┘ └──────────────────┘
```

### URL Usage by Context

| Context | Variable | Format | Example |
|---------|----------|--------|---------|
| CLI (npx convex) | CONVEX_SELF_HOSTED_URL | localhost:port | `http://127.0.0.1:3230` |
| Browser (sync) | NEXT_PUBLIC_CONVEX_URL | proxy URL | `https://james.convex.cloud.loc` |
| Browser (HTTP) | NEXT_PUBLIC_CONVEX_HTTP_URL | proxy URL | `https://james.convex.site.loc` |
| Convex Backend | SITE_URL | proxy URL | `https://james.loc` |
| Convex Backend | CONVEX_SELF_HOSTED_URL | proxy URL | `https://james.convex.cloud.loc` |

---

## API Contract: agent-init.sh

### Inputs
- Directory name matching pattern `artifact-review-{agent-name}`
- `../artifact-review-orchestrator/config.json` with agent configuration

### Outputs
- `.env.docker.local` - Docker compose configuration
- `app/.env.nextjs.local` - Next.js runtime configuration
- `app/.env.local` - Convex URL configuration (dynamic)
- Convex environment variables set via `npx convex env set`
- Running Docker services
- Running tmux sessions (Next.js, Convex dev, Stripe)

### Exit Codes
- 0: Success
- 1: Prerequisites missing
- 2: Orchestrator not available
- 3: Docker services failed to start
- 4: Convex configuration failed
- 5: Dev servers failed to start

### Flags
- `--check` - Show current state without making changes
- `--env-only` - Only generate env files, don't start services
- `--skip-novu` - Skip Novu organization setup
- `--force` - Force regeneration of all files

---

## Component Design: Script Responsibilities

### agent-init.sh (Orchestrator)
- Detects agent name from directory
- Reads config.json for port assignments
- Generates ALL env files
- Calls child scripts in correct order
- Provides clear progress output
- Handles errors gracefully

### generate-all-env.sh (Generator)
- Pure function: config.json → env files
- No side effects beyond file writes
- Validates required config values exist
- Uses correct port derivation

### wait-for-services.sh (Health Checker)
- Polls endpoints until healthy
- Configurable timeout and retry count
- Returns meaningful exit codes
- Outputs clear status messages

### setup-convex-env.sh (Convex Configurator)
- Already handles JWT key generation
- Already handles admin key retrieval
- Add: RESEND_API_KEY setting
- Add: Return code for restart needed

### setup-novu-org.sh (Novu Configurator)
- Already idempotent (login or register)
- Already updates .env.nextjs.local
- No changes needed

---

## Implementation Phases

### Phase 1: Environment Generation (Highest Priority)
1. Create `scripts/generate-all-env.sh`
2. Update `agent-init.sh` to call it
3. Fix placeholder replacement (YOUR_USERNAME → actual)
4. Add NODE_EXTRA_CA_CERTS auto-detection

### Phase 2: Health Checks
1. Create `scripts/wait-for-services.sh`
2. Add health check between Docker start and dev servers
3. Add health check before showing "complete" status

### Phase 3: Convex Integration
1. Add RESEND_API_KEY to `setup-convex-env.sh`
2. Add Convex dev server restart after env changes
3. Create `scripts/restart-convex-dev.sh`

### Phase 4: Error Handling
1. Add meaningful exit codes
2. Add rollback on failure
3. Add `--check` mode improvements

### Phase 5: Documentation
1. Update CLAUDE.md with new flow
2. Update troubleshooting.md
3. Add comments to all scripts

---

## Risk Analysis

### Low Risk
- Environment file generation - pure file operations
- Health checks - read-only operations
- Novu setup - already idempotent

### Medium Risk
- Changing `agent-init.sh` flow - could break existing agents
- Docker restart logic - data persistence is critical

### High Risk
- Convex env var changes - could invalidate sessions
- JWT key handling - security sensitive

### Mitigations
- Add `--dry-run` flag for testing
- Keep old files as `.backup` during transition
- Test with new agent name first (not existing agent)

---

## Testing Strategy

### Manual Validation
1. Create new worktree: `git worktree add ../artifact-review-test test-agent`
2. Run `./scripts/agent-init.sh`
3. Verify all URLs work
4. Time the process

### Automated Checks
1. Port numbers in all files match config.json
2. No placeholder values remain
3. All required env vars are set
4. All services respond to health checks

### Acceptance Test
```bash
# From clean checkout
time ./scripts/agent-init.sh
# Should complete in < 2 minutes

# Verify working
curl -s https://${AGENT_NAME}.loc | head -5
curl -s https://${AGENT_NAME}.convex.cloud.loc/version
```

---

## Appendix: Port Derivation Rules

From `config.json`, ports are assigned explicitly. If calculating from `appPort`:

| Port | Formula | Example (james, appPort=3020) |
|------|---------|-------------------------------|
| Next.js | appPort | 3020 |
| Convex Cloud (Admin/WS) | appPort + 210 | 3230 |
| Convex Site (HTTP) | appPort + 211 | 3231 |
| Convex Dashboard | appPort + 3791 | 6811 |
| Mailpit Web | appPort + 5025 | 8045 |
| Mailpit SMTP | appPort + 1025 | 4045 |

Note: config.json uses explicit values, but the derivation formula in `start-dev-servers.sh` uses these offsets.
