name: Production E2E Tests

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      test_suites:
        description: 'Test suites to run (comma-separated, or "all"). Available: agent-api, agent-api-versions, annotation-sidebar, artifact-workflow, auth, collaboration, email-digest, notification, public-share, smoke-integrations, stripe-subscription'
        required: false
        default: 'all'
      exclude_suites:
        description: 'Test suites to exclude (comma-separated). Takes precedence over test_suites. Default excludes stripe-subscription (live payments).'
        required: false
        default: 'stripe-subscription'
      run_digest_tests:
        description: 'Run email digest tests (slow, requires 30s+ digest interval)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    timeout-minutes: 25

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: Install dependencies
        working-directory: ./app
        run: npm install --legacy-peer-deps

      - name: Install Playwright browsers
        working-directory: ./app
        run: npx playwright install chromium --with-deps

      - name: Wait for deployment to be fully ready
        run: |
          echo "Waiting for production deployment to be fully operational..."
          DEPLOY_URL="https://artifactreview.com"
          MAX_ATTEMPTS=30
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            if curl -sf "$DEPLOY_URL" > /dev/null; then
              echo "‚úÖ Deployment is ready at $DEPLOY_URL"
              break
            fi
            echo "‚è≥ Attempt $ATTEMPT/$MAX_ATTEMPTS - waiting for deployment..."
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
            echo "‚ùå Deployment not ready after $MAX_ATTEMPTS attempts"
            exit 1
          fi

      - name: Run E2E tests
        working-directory: ./app
        env:
          # Test against live production deployment
          TEST_BASE_URL: https://artifactreview.com
          # SITE_URL is used for magic link redirect URL rewriting
          SITE_URL: https://artifactreview.com
          # Use production Convex deployment
          NEXT_PUBLIC_CONVEX_URL: https://gallant-wolverine-81.convex.cloud
          # Convex HTTP actions endpoint
          NEXT_PUBLIC_CONVEX_HTTP_URL: https://gallant-wolverine-81.convex.site
          # Required for email verification in tests
          RESEND_FULL_ACCESS_API_KEY: ${{ secrets.RESEND_FULL_ACCESS_API_KEY }}
          RUN_DIGEST_TESTS: ${{ github.event.inputs.run_digest_tests == 'true' && 'true' || '' }}
        run: |
          # Build test file list based on workflow inputs
          TEST_SUITES="${{ github.event.inputs.test_suites || 'all' }}"
          EXCLUDE_SUITES="${{ github.event.inputs.exclude_suites || 'stripe-subscription' }}"
          TEST_FILES=""

          if [ "$TEST_SUITES" != "all" ] && [ -n "$TEST_SUITES" ]; then
            # Run only specified suites
            IFS=',' read -ra SUITES <<< "$TEST_SUITES"
            for suite in "${SUITES[@]}"; do
              suite=$(echo "$suite" | xargs)
              TEST_FILES="$TEST_FILES tests/e2e/${suite}.spec.ts"
            done
          elif [ -n "$EXCLUDE_SUITES" ]; then
            # Run all except excluded suites
            for f in tests/e2e/*.spec.ts; do
              BASENAME=$(basename "$f" .spec.ts)
              SKIP=false
              IFS=',' read -ra EXCLUDES <<< "$EXCLUDE_SUITES"
              for exc in "${EXCLUDES[@]}"; do
                exc=$(echo "$exc" | xargs)
                if [ "$BASENAME" = "$exc" ]; then
                  SKIP=true
                  break
                fi
              done
              if [ "$SKIP" = false ]; then
                TEST_FILES="$TEST_FILES $f"
              fi
            done
          fi

          echo "üß™ Test configuration: suites=$TEST_SUITES exclude=$EXCLUDE_SUITES"
          if [ -n "$TEST_FILES" ]; then
            echo "üìã Running specific files:$TEST_FILES"
          else
            echo "üìã Running all tests"
          fi

          # Run tests and capture output (don't exit on failure)
          npm run test:e2e -- $TEST_FILES 2>&1 | tee test-output.log || true

          # Parse test results
          FAILED=$(grep -oP '\d+(?= failed)' test-output.log | tail -1 || echo "0")
          PASSED=$(grep -oP '\d+(?= passed)' test-output.log | tail -1 || echo "0")
          SKIPPED=$(grep -oP '\d+(?= skipped)' test-output.log | tail -1 || echo "0")

          FAILED=${FAILED:-0}
          PASSED=${PASSED:-0}
          SKIPPED=${SKIPPED:-0}

          echo "test_failed=$FAILED" >> $GITHUB_OUTPUT
          echo "test_passed=$PASSED" >> $GITHUB_OUTPUT
          echo "test_skipped=$SKIPPED" >> $GITHUB_OUTPUT

          echo "üìä Test Results: $PASSED passed, $FAILED failed, $SKIPPED skipped"

          if [ "$FAILED" -gt 0 ]; then
            echo "tests_passed=false" >> $GITHUB_OUTPUT
            echo "‚ùå $FAILED tests failed"
          else
            echo "tests_passed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ All tests passed"
          fi
        id: e2e_tests
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: app/playwright-report/
          retention-days: 7

      - name: Upload test videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-videos
          path: app/test-results/
          retention-days: 7

      - name: Comment on commit with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const testsPassed = '${{ steps.e2e_tests.outputs.tests_passed }}' === 'true';
            const passed = '${{ steps.e2e_tests.outputs.test_passed }}' || '0';
            const failed = '${{ steps.e2e_tests.outputs.test_failed }}' || '0';
            const skipped = '${{ steps.e2e_tests.outputs.test_skipped }}' || '0';
            const deployUrl = 'https://artifactreview.com';
            const sha = '${{ github.sha }}';
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            const body = testsPassed
              ? `‚úÖ **Production Auth E2E Tests Passed**

            | Passed | Failed | Skipped |
            |--------|--------|---------|
            | ${passed} | ${failed} | ${skipped} |

            **Deployment:** ${deployUrl}
            **Commit:** ${sha.substring(0, 7)}

            Auth flows working correctly. üéâ`
              : `‚ùå **Production Auth E2E Tests Failed**

            | Passed | Failed | Skipped |
            |--------|--------|---------|
            | ${passed} | ${failed} | ${skipped} |

            **Deployment:** ${deployUrl}
            **Commit:** ${sha.substring(0, 7)}
            **Test Run:** [View Details](${runUrl})

            Review test artifacts for failure details.`;

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha,
              body: body
            });

      - name: Create issue if tests fail
        if: steps.e2e_tests.outputs.tests_passed != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ github.sha }}';
            const passed = '${{ steps.e2e_tests.outputs.test_passed }}' || '0';
            const failed = '${{ steps.e2e_tests.outputs.test_failed }}' || '0';
            const skipped = '${{ steps.e2e_tests.outputs.test_skipped }}' || '0';
            const deployUrl = 'https://artifactreview.com';
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Production Auth Tests Failed - ${failed} failures (${sha.substring(0, 7)})`,
              body: `## Production Auth Test Failure

            | Passed | Failed | Skipped |
            |--------|--------|---------|
            | ${passed} | ${failed} | ${skipped} |

            **Deployment:** ${deployUrl}
            **Commit:** ${sha}
            **Test Run:** [View Details](${runUrl})

            ### Auth Tests Check
            - Password signup flow
            - Magic link flow

            ### Next Steps

            1. Review test artifacts in the [Actions run](${runUrl})
            2. Check Convex logs for errors
            3. Verify JWT keys are correctly configured

            ---
            *Auto-generated by production E2E workflow*`,
              labels: ['production', 'auth', 'e2e-failure']
            });

      - name: Fail workflow if tests failed
        if: steps.e2e_tests.outputs.tests_passed != 'true'
        run: |
          echo "‚ùå Auth E2E tests failed"
          echo "Review test artifacts for debugging"
          exit 1
