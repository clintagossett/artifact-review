name: Staging E2E Tests

on:
  push:
    branches:
      - staging
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write  # Needed for commit comments
  issues: write
  pull-requests: write

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    timeout-minutes: 25

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: staging

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: Install dependencies
        working-directory: ./app
        run: npm install --legacy-peer-deps

      - name: Install Playwright browsers
        working-directory: ./app
        run: npx playwright install chromium --with-deps

      - name: Wait for deployment to be fully ready
        run: |
          echo "Waiting for staging deployment to be fully operational..."
          DEPLOY_URL="https://artifactreview-early.xyz"
          MAX_ATTEMPTS=30
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            if curl -sf "$DEPLOY_URL" > /dev/null; then
              echo "‚úÖ Deployment is ready at $DEPLOY_URL"
              break
            fi
            echo "‚è≥ Attempt $ATTEMPT/$MAX_ATTEMPTS - waiting for deployment..."
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
            echo "‚ùå Deployment not ready after $MAX_ATTEMPTS attempts"
            exit 1
          fi

      - name: Run E2E tests
        working-directory: ./app
        env:
          # Test against live staging deployment (not local server)
          TEST_BASE_URL: https://artifactreview-early.xyz
          # SITE_URL is used for magic link redirect URL rewriting
          SITE_URL: https://artifactreview-early.xyz
          # Use staging Convex deployment
          NEXT_PUBLIC_CONVEX_URL: https://adventurous-mosquito-571.convex.cloud
          # Convex HTTP actions endpoint (for API tests)
          NEXT_PUBLIC_CONVEX_HTTP_URL: https://adventurous-mosquito-571.convex.site
          # Required for email verification in tests
          RESEND_FULL_ACCESS_API_KEY: ${{ secrets.RESEND_FULL_ACCESS_API_KEY }}
        run: |
          # Run tests and capture output
          if npm run test:e2e 2>&1 | tee test-output.log; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          else
            # Check if tests actually passed (Playwright exits 1 on flaky tests)
            if grep -q "passed" test-output.log && ! grep -q "failed" test-output.log | grep -v "Slow test"; then
              echo "tests_passed=true" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Tests passed but Playwright reported flaky tests"
            else
              echo "tests_passed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
        id: e2e_tests
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: app/playwright-report/
          retention-days: 7

      - name: Upload test videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-videos
          path: app/test-results/
          retention-days: 7

      - name: Comment on commit with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const testsPassed = '${{ steps.e2e_tests.outputs.tests_passed }}' === 'true';
            const deployUrl = 'https://artifactreview-early.xyz';
            const sha = '${{ github.sha }}';

            const body = testsPassed
              ? `‚úÖ **E2E Tests Passed** for staging deployment

            **Deployment URL:** ${deployUrl}
            **Commit:** ${sha.substring(0, 7)}

            All E2E tests passed successfully! Staging is healthy. üéâ`
              : `‚ùå **E2E Tests Failed** for staging deployment

            **Deployment URL:** ${deployUrl}
            **Commit:** ${sha.substring(0, 7)}

            E2E tests failed. Review the test results and consider rolling back.

            **Rollback Options:**
            1. **Vercel Dashboard:** Go to [Vercel Dashboard](https://vercel.com/clintagossett/artifact-review-staging/deployments) and redeploy previous version
            2. **Vercel CLI:** \`vercel rollback --token $VERCEL_TOKEN\`
            3. **Git Revert:** \`git revert ${sha} && git push origin staging\`

            **Test Artifacts:**
            - [Playwright Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Check artifacts for videos and detailed logs

            ‚ö†Ô∏è **Action Required:** Investigate failures and rollback if necessary.`;

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha,
              body: body
            });

      - name: Create issue if tests fail
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ github.sha }}';
            const deployUrl = 'https://artifactreview-early.xyz';
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Staging E2E Tests Failed - ${sha.substring(0, 7)}`,
              body: `## E2E Test Failure on Staging

            **Deployment URL:** ${deployUrl}
            **Commit:** ${sha}
            **Test Run:** ${runUrl}

            ### Details

            E2E tests failed after deployment to staging. This may indicate:
            - Breaking changes in the code
            - Backend service issues (Convex, Novu, Resend)
            - Test flakiness (network issues, timing)

            ### Immediate Actions

            1. **Review test results:** Check artifacts in [Actions run](${runUrl})
            2. **Check staging site:** Visit ${deployUrl} and verify manually
            3. **Check backend health:**
               - Convex: https://adventurous-mosquito-571.convex.cloud
               - Check logs: \`npx convex logs --limit 100\`
            4. **Consider rollback:** If issue is critical, redeploy previous version

            ### Rollback Commands

            \`\`\`bash
            # Option 1: Vercel CLI rollback
            vercel rollback --token $VERCEL_TOKEN

            # Option 2: Git revert
            git revert ${sha}
            git push origin staging

            # Option 3: Vercel Dashboard
            # Go to: https://vercel.com/clintagossett/artifact-review-staging/deployments
            # Click "Redeploy" on previous successful deployment
            \`\`\`

            ### Next Steps

            - [ ] Investigate test failures
            - [ ] Reproduce locally: \`PLAYWRIGHT_BASE_URL=https://artifactreview-early.xyz npm run test:e2e\`
            - [ ] Fix issues
            - [ ] Close issue when resolved

            ---

            **Auto-generated by staging E2E workflow**`,
              labels: ['staging', 'e2e-failure', 'urgent']
            });

      - name: Fail workflow if tests failed
        if: steps.e2e_tests.outputs.tests_passed != 'true'
        run: |
          echo "‚ùå E2E tests failed"
          echo "Review test artifacts and consider rolling back deployment"
          exit 1

  notify-slack:
    needs: e2e-tests
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack on failure
        # Only enable if you have Slack webhook configured
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST $SLACK_WEBHOOK_URL \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "üö® Staging E2E Tests Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Staging E2E Tests Failed*\n\nCommit: `${{ github.sha }}`\nDeployment: https://artifactreview-early.xyz\n\n*Action Required:* Review failures and consider rollback."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Test Results"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Vercel Dashboard"
                      },
                      "url": "https://vercel.com/clintagossett/artifact-review-staging/deployments"
                    }
                  ]
                }
              ]
            }'
